# Copyright (c) 2005 Atheme Development Group
# Rights to this code are documented in doc/LICENSE.
#
# This file contains build instructions.
#
# $Id: Makefile.in 7823 2007-03-05 23:20:25Z pippijn $
#

CC		= @CC@
RM		= @RM@
MV		= @MV@
CP		= @CP@
INSTALL		= @INSTALL@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
datadir		= @datadir@
sysconfdir	= @sysconfdir@
libdir		= @libdir@
sbindir		= @sbindir@
localstatedir	= @localstatedir@
DOCDIR		= @DOCDIR@
MODDIR		= @MODDIR@
DATADIR		= @DATADIR@
RUNDIR		= @RUNDIR@
LOGDIR		= @LOGDIR@
SHAREDIR	= @SHAREDIR@
BIN		= atheme@EXEEXT@
LOCALEDIR 	= @LOCALEDIR@

MKDEP		= @MKDEP@
CFLAGS		= @CFLAGS@ -I../include -I../intl

VERSION		= @PACKAGE_VERSION@

LIBS		= @LIBS@
LDFLAGS		= @LDFLAGS@
CPPFLAGS	= @CPPFLAGS@
SOCKET_ENGINE   = @SOCKET_ENGINE@.c

default: all

BASE_SRCS =		\
	account.c	\
	atheme.c	\
	arc4random.c	\
	authcookie.c	\
	balloc.c        \
	base64.c	\
	channels.c	\
	cidr.c		\
	cmode.c		\
	commandtree.c	\
	ctcp-common.c	\
	conf.c		\
	confparse.c	\
	connection.c    \
	crypto.c	\
	culture.c	\
	datastream.c	\
	dbhandler.c	\
	dictionary.c	\
	dlink.c         \
	event.c		\
	flags.c		\
	function.c	\
	help.c		\
	hook.c		\
	linker.c	\
	match.c		\
	md5.c		\
	memory.c	\
	module.c	\
	node.c		\
	object.c	\
	packet.c	\
	parse.c		\
	phandler.c	\
	pmodule.c	\
	privs.c		\
	ptasks.c	\
	send.c		\
	servers.c	\
	services.c	\
	servtree.c	\
	signal.c	\
	sockio.c	\
	string.c	\
	svsignore.c	\
	template.c	\
	tokenize.c	\
	ubase64.c	\
	users.c		\
	uid.c		\
	uplink.c	\
	xmlrpc.c	\
	${SOCKET_ENGINE}

SRCS = ${BASE_SRCS} version.c

OBJS = ${SRCS:.c=.o}

all: atheme ../dist/example.userserv.conf

build: all

atheme: $(OBJS)
	${CC} ${CFLAGS} ${LDFLAGS} -o $@ ${OBJS} ${LIBS}
	$(MV) version.c version.c.last

../dist/example.userserv.conf: ../dist/example.conf
	(echo '/* example.userserv.conf, autogenerated from example.conf */'; \
	sed -e 's@loadmodule "modules/nickserv/identify";@#&@' \
	  -e 's@loadmodule "modules/nickserv/ghost";@#&@' \
	  -e 's@#loadmodule "modules/nickserv/login";@loadmodule "modules/nickserv/login";@' \
	  -e 's/spam;/#spam;/' \
	  -e 's/#no_nick_ownership;/no_nick_ownership;/' \
	  -e 's/nick = "NickServ";/nick = "UserServ";/' \
	  -e 's/user = "NickServ";/user = "UserServ";/' \
	  -e 's/real = "Nickname Services";/real = "User Registration Services";/' ../dist/example.conf) >../dist/example.userserv.conf

install: build
	$(INSTALL) -m 755 -d $(DESTDIR)$(prefix)
	$(INSTALL) -m 755 -d $(DESTDIR)$(bindir)
	$(INSTALL) -m 755 -d $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 755 -d $(DESTDIR)$(localstatedir)
	$(INSTALL) -m 755 -d $(DESTDIR)$(DOCDIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(LOGDIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(RUNDIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(DATADIR)
	$(INSTALL) -m 755 -d $(DESTDIR)$(SHAREDIR)/help
	$(INSTALL) -m 755 -c $(BIN) $(DESTDIR)$(bindir)
	$(INSTALL) -m 640 -c ../dist/example.conf $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 640 -c ../dist/example.motd $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 640 -c ../dist/example.userserv.conf $(DESTDIR)$(sysconfdir)
	$(INSTALL) -m 640 -c ../dist/atheme.chk $(DESTDIR)$(sysconfdir)/atheme.chk.sample
	(cd ../doc; for i in *; do $(INSTALL) -m 644 $$i $(DESTDIR)$(DOCDIR); done)
	(cd ../help; for i in *; do \
		[ -f $$i ] && $(INSTALL) -m 644 $$i $(DESTDIR)$(SHAREDIR)/help; \
		if [ -d $$i ]; then \
			cd $$i; \
			$(INSTALL) -m 755 -d $(DESTDIR)$(SHAREDIR)/help/$$i; \
			for j in *; do \
				[ -f $$j ] && $(INSTALL) -m 644 $$j $(DESTDIR)$(SHAREDIR)/help/$$i; \
			done; \
			cd ..; \
		fi; \
	done)

	@echo "----------------------------------------------------------------"
	@echo ">>> Remember to cd to ${prefix} and edit your config file.";
	@echo "----------------------------------------------------------------"

#deinstall:
#	if [ -d ${prefix} ] ; then \
#		$(RM) -rf ${prefix}; \
#	fi

version.c:
	/bin/sh ./version.sh $(VERSION)

.c.o:
	${CC} ${CPPFLAGS} ${CFLAGS} -c $< -o $@

.PHONY: depend clean distclean
depend:
	${MKDEP} ${CPPFLAGS} ${CFLAGS} ${BASE_SRCS} > .depend

clean:
	${RM} -f *.o *.exe *~ version.c atheme.core core atheme ../dist/example.userserv.conf

distclean: clean
	${RM} -f Makefile version.c.last

include .depend
